---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { format } from 'date-fns';
import { fr } from 'date-fns/locale';

// Get all radio entries
const radioEntries = await getCollection('radio');

// Sort by date desc
radioEntries.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const radioEntriesWithContent = await Promise.all(radioEntries.map(async (entry) => {
  const { Content } = await entry.render();
  return { ...entry, Content };
}));

// Group by date
const groupedEntries = radioEntriesWithContent.reduce((acc, entry) => {
  const dateKey = format(entry.data.date, 'yyyy-MM-dd');
  if (!acc[dateKey]) {
    acc[dateKey] = [];
  }
  acc[dateKey].push(entry);
  return acc;
}, {});

const dates = Object.keys(groupedEntries).sort((a, b) => new Date(b).getTime() - new Date(a).getTime());
---

<Layout title="Radio Rayonis | Veille IA AutomatisÃ©e">
  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <header class="mb-12 text-center">
      <h1 class="text-5xl font-black mb-4 uppercase tracking-tighter transform -rotate-1">
        ðŸ“» Radio Rayonis
      </h1>
      <p class="text-xl font-bold bg-black text-white inline-block px-4 py-2 transform rotate-1 border-2 border-black">
        La Veille IA AutomatisÃ©e par Jules ðŸ¤–
      </p>
    </header>

    <div class="space-y-16">
      {dates.map((date) => (
        <section class="relative">
          <div class="absolute -left-4 -top-4 w-16 h-16 bg-accent rounded-full opacity-20 blur-xl"></div>
          
          <h2 class="text-3xl font-black mb-8 border-b-4 border-black pb-2 inline-block">
            ðŸ“… Ã‰dition du {format(new Date(date), 'dd MMMM yyyy', { locale: fr })}
          </h2>

          <div class="grid gap-8">
            {groupedEntries[date].map((entry) => (
              <article class="bg-white border-4 border-black p-6 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] hover:translate-x-1 hover:-translate-y-1 hover:shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] transition-all duration-200">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="text-4xl">{entry.data.emoji || 'ðŸ“»'}</span>
                    <span class="font-bold bg-yellow-300 px-2 py-1 border-2 border-black text-xs uppercase">
                      Score Vibe: {entry.data.score}/100
                    </span>
                  </div>
                  <span class="text-sm font-bold text-gray-500 bg-gray-100 px-2 py-1 border-2 border-gray-300 rounded">
                    {entry.data.category || 'Tech'}
                  </span>
                </div>

                <h3 class="text-2xl font-black mb-2 leading-tight">
                  <a href={entry.data.link} target="_blank" rel="noopener noreferrer" class="hover:underline decoration-4 decoration-accent">
                    {entry.data.title}
                  </a>
                </h3>

                <div class="prose prose-lg prose-p:font-medium prose-p:text-gray-800 mb-6">
                  <entry.Content />
                </div>

                <div class="flex justify-between items-center mt-6 pt-4 border-t-2 border-dashed border-gray-300">
                  <span class="font-mono text-xs text-gray-500">
                    Source: {entry.data.source || 'Flux RSS'}
                  </span>
                  <a href={entry.data.link} target="_blank" rel="noopener noreferrer" class="font-black bg-black text-white px-4 py-2 border-2 border-transparent hover:bg-white hover:text-black hover:border-black transition-colors">
                    Lire l'article original â†’
                  </a>
                </div>
              </article>
            ))}
          </div>
        </section>
      ))}
      
      {dates.length === 0 && (
        <div class="text-center py-20 bg-gray-100 border-4 border-black border-dashed">
          <p class="text-2xl font-bold text-gray-500">ðŸ˜´ Aucune Ã©mission pour le moment...</p>
          <p class="mt-2">Revenez demain pour le brief de Jules !</p>
        </div>
      )}
    </div>
  </main>
</Layout>
